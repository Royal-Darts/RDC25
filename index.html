<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Royal Darts Carnival 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#a81100">
  <link rel="icon" type="image/avif" href="https://i.postimg.cc/jSXT8DK8/temp-Image-El-Y5kn.avif">
  <style>
    :root {
      --primary: #a81100;
      --gold: #ffe174;
      --silver: #d2d7df;
      --eliminated: #ffefef;
      --highlight: #fff6dd;
      --background: #fafafa;
      --surface: #fff;
      --accent: #0b2239;
      --border: #e2e8f0;
      --radius: 18px;
      --shadow: 0 4px 16px rgba(0,0,0,0.06);
      --logo-size: 44px;
      --transition: 0.2s cubic-bezier(.4,0,.2,1);
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      background: var(--background);
      color: var(--accent);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    body { display: flex; flex-direction: column; min-height: 100vh; }
    header {
      background: var(--surface);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      padding: 0 18px;
      gap: 14px;
      height: 68px;
      position: sticky; top: 0; z-index: 10;
    }
    header img {
      width: var(--logo-size);
      height: var(--logo-size);
      border-radius: 50%;
      background: #fff;
      object-fit: cover;
      box-shadow: 0 1px 4px #0001;
    }
    header h1 {
      font-size: 1.55rem;
      letter-spacing: .01em;
      margin: 0;
      color: var(--primary);
      font-weight: 900;
    }
    nav {
      flex: 1;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }
    nav button {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 1rem;
      padding: 9px 15px;
      font-weight: 500;
      border-radius: 20px;
      transition: background var(--transition);
      cursor: pointer;
      outline: none;
    }
    nav button.active, nav button:focus-visible {
      background: var(--primary);
      color: #fff;
    }
    main {
      flex: 1;
      padding: 24px 0 32px 0;
      max-width: 1100px;
      margin: 0 auto;
      width: 100%;
      min-height: 60vh;
    }
    section[hidden] { display: none !important; }
    .highlight-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px 30px;
      margin-bottom: 32px;
    }
    .stat-card {
      background: var(--highlight);
      border-radius: var(--radius);
      padding: 18px 20px 16px 20px;
      box-shadow: 0 2px 10px #0001;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-height: 96px;
      justify-content: center;
      gap: 5px;
      position: relative;
    }
    .stat-card .label {
      font-size: 1.07rem;
      font-weight: 700;
      color: var(--primary);
      opacity: .89;
    }
    .stat-card .value {
      font-size: 1.75rem;
      font-weight: 900;
      color: var(--accent);
      line-height: 1.08;
      margin-top: 3px;
    }
    .stat-card .player {
      font-size: 1.09rem;
      font-weight: 500;
      color: var(--accent);
      opacity: 0.84;
      margin-top: -2px;
    }
    .quick-standings {
      margin-top: 14px;
      margin-bottom: 10px;
      border-radius: var(--radius);
      box-shadow: 0 1px 8px #0001;
      overflow: hidden;
      background: var(--surface);
    }
    .quick-standings th, .quick-standings td {
      padding: 7px 8px;
      text-align: center;
    }
    .quick-standings th {
      background: #f5f5f5;
      font-size: 0.98em;
      font-weight: 700;
      color: var(--primary);
    }
    .cup-gold { background: linear-gradient(90deg, var(--gold) 95%, #fff5 100%); }
    .cup-silver { background: linear-gradient(90deg, var(--silver) 95%, #fff 100%); }
    .cup-eliminated { background: var(--eliminated); }
    .fixtures-list, .results-list { margin-bottom: 30px; }
    .fixtures-list .date-group, .results-list .date-group {
      margin-bottom: 17px;
    }
    .fixtures-list .date-label, .results-list .date-label {
      font-weight: 700;
      font-size: 1.07em;
      margin: 12px 0 8px 3px;
      color: var(--primary);
    }
    .fixtures-list table, .results-list table, .standings-table, .stats-table, .squads-table, .top10-table {
      width: 100%;
      border-spacing: 0;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 1px 10px #0001;
      background: var(--surface);
    }
    .fixtures-list th, .results-list th, .standings-table th, .stats-table th, .squads-table th, .top10-table th {
      background: #f5f5f5;
      padding: 9px 6px;
      font-size: 1em;
      font-weight: 700;
      color: var(--primary);
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    .fixtures-list td, .results-list td, .standings-table td, .stats-table td, .squads-table td, .top10-table td {
      padding: 8px 5px;
      text-align: center;
      font-size: 0.97em;
      border-bottom: 1px solid var(--border);
    }
    .winner-cell {
      font-weight: 700;
      color: #388700;
      background: #e9ffe3;
      border-radius: 8px;
    }
    .stats-table .player-link, .squads-table .player-link {
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      text-decoration: underline dotted;
      background: none;
      border: none;
      padding: 0;
    }
    .team-filter {
      width: 180px;
      margin: 8px 0 14px 0;
      border-radius: 18px;
      padding: 8px 10px;
      border: 1px solid #ccc;
      font-size: 1em;
      background: #fff;
      color: #222;
    }
    .popup-backdrop {
      display: none;
      position: fixed;
      z-index: 99;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: #0006;
      align-items: center; justify-content: center;
      transition: opacity 0.13s;
    }
    .popup-backdrop.show { display: flex; }
    .popup-card {
      background: #fff;
      border-radius: 32px;
      box-shadow: 0 8px 40px #0003;
      padding: 30px 32px 25px 32px;
      max-width: 98vw;
      min-width: 290px;
      width: 420px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      animation: popupAppear 0.22s cubic-bezier(.68,-0.55,.27,1.55);
    }
    @keyframes popupAppear { from { transform: scale(.92); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .popup-card img {
      width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
      border: 4px solid var(--primary); background: #fff;
      margin-bottom: 12px;
    }
    .popup-card .name { font-size: 1.44rem; font-weight: 800; color: var(--primary); }
    .popup-card .team { font-size: 1.07rem; color: #555; margin-bottom: 13px;}
    .popup-card .stats-sections {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 28px;
      margin-top: 6px;
      margin-bottom: 7px;
      width: 100%;
    }
    .popup-card .stat-group-title {
      color: var(--primary); font-weight: 700; margin: 7px 0 4px 0;
      font-size: 1.05em;
      grid-column: 1 / span 2;
    }
    .popup-card table.stats-list {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 4px;
    }
    .popup-card .stats-list td {
      padding: 4px 6px 4px 0;
      text-align: left;
      font-size: 0.98em;
    }
    .popup-card .stats-list td:first-child { font-weight: 600; color: #444;}
    .popup-card .stats-list td:last-child { font-weight: 700; color: var(--accent);}
    .popup-card .close-btn {
      position: absolute; top: 13px; right: 16px;
      font-size: 1.7em; color: #888; background: none;
      border: none; cursor: pointer; transition: color 0.17s;
    }
    .popup-card .close-btn:hover { color: var(--primary);}
    .save-card-btn {
      margin-top: 20px;
      background: var(--primary);
      color: #fff;
      font-weight: 700;
      padding: 10px 19px;
      border: none;
      border-radius: 20px;
      font-size: 1.04em;
      box-shadow: 0 1px 10px #0001;
      cursor: pointer;
      transition: background 0.19s;
    }
    .save-card-btn:hover { background: #600900; }
    .tab-title {
      font-size: 1.23em;
      font-weight: 700;
      margin: 19px 0 13px 3px;
      color: var(--primary);
    }
    footer {
      width: 100%;
      background: var(--surface);
      box-shadow: 0 -1px 8px #0001;
      padding: 18px 0 12px 0;
      text-align: center;
      color: #aaa;
      font-size: 1em;
      font-weight: 500;
      letter-spacing: 0.02em;
      border-top-left-radius: var(--radius);
      border-top-right-radius: var(--radius);
    }
    @media (max-width: 750px) {
      .highlight-cards { grid-template-columns: 1fr; }
      .popup-card { width: 99vw; min-width: 0; }
      .popup-card .stats-sections { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
      main { padding: 13px 0 25px 0; }
      header { height: 54px; padding: 0 6px; }
      header img { --logo-size: 30px; }
      .popup-card { padding: 18px 6vw 12px 6vw; width: 99vw;}
      .tab-title { font-size: 1.07em;}
      .highlight-cards { gap: 10px;}
      .fixtures-list th, .results-list th, .standings-table th, .stats-table th, .top10-table th { font-size: 0.95em; }
    }
    /* Squads styling */
    #squads-list { margin-top: 10px; }
    .squad-team-section {
      margin-bottom: 19px;
    }
    .squad-team-name {
      font-size: 1.12em;
      font-weight: 700;
      color: var(--primary);
      margin: 2px 0 5px 0;
      padding-left: 5px;
    }
    .squad-player-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px,1fr));
      gap: 12px;
    }
    .squad-player-card {
      background: var(--surface);
      box-shadow: 0 2px 8px #0001;
      border-radius: 14px;
      padding: 11px 7px 13px 7px;
      text-align: center;
      min-height: 72px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.06em;
    }
    .squad-player-card button {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 1.08em;
      font-weight: 600;
      cursor: pointer;
      text-decoration: underline dotted;
      padding: 0;
      margin: 0 0 2px 0;
    }
    .squad-player-card .squad-sets { color: #666; font-size: 0.92em; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
<header>
  <img src="https://i.postimg.cc/jSXT8DK8/temp-Image-El-Y5kn.avif" alt="Royal Darts Carnival 2025 Logo" loading="lazy">
  <h1>Royal Darts Carnival 2025</h1>
  <nav id="navbar" aria-label="Main Navigation">
    <button data-tab="home" class="active" aria-current="page">Home</button>
    <button data-tab="fixtures">Fixtures</button>
    <button data-tab="results">Results</button>
    <button data-tab="standings">Standings</button>
    <button data-tab="stats">Stats</button>
    <button data-tab="top10">Top 10</button>
    <button data-tab="live">Live</button>
    <button data-tab="squads">Squads</button>
  </nav>
</header>
<main>
  <!-- Home -->
  <section id="tab-home">
    <div class="tab-title">Stat Highlights</div>
    <div class="highlight-cards" id="stat-highlights"></div>
    <div class="tab-title">Quick Standings</div>
    <table class="quick-standings" id="quick-standings"></table>
    <div class="tab-title">Today’s Fixtures</div>
    <div class="fixtures-list" id="today-fixtures"></div>
  </section>
  <!-- Fixtures -->
  <section id="tab-fixtures" hidden>
    <div class="tab-title">All Fixtures</div>
    <div class="fixtures-list" id="fixtures-list"></div>
  </section>
  <!-- Results -->
  <section id="tab-results" hidden>
    <div class="tab-title">All Results</div>
    <div class="results-list" id="results-list"></div>
  </section>
  <!-- Standings -->
  <section id="tab-standings" hidden>
    <div class="tab-title">Group Standings</div>
    <div id="standings-tables"></div>
  </section>
  <!-- Stats -->
  <section id="tab-stats" hidden>
    <div class="tab-title">Player Statistics</div>
    <select id="team-filter" class="team-filter">
      <option value="">All Teams</option>
    </select>
    <input id="stats-search" placeholder="Search player..." style="width:98%;max-width:330px;padding:9px 10px;border-radius:20px;border:1px solid #e3e3e3;margin:8px 0 18px 0;font-size:1em;">
    <div style="overflow-x:auto">
      <table class="stats-table" id="stats-table"></table>
    </div>
  </section>
  <!-- Top 10 -->
  <section id="tab-top10" hidden>
    <div class="tab-title">Top 10 Rankings</div>
    <div id="top10-tables"></div>
  </section>
  <!-- Live -->
  <section id="tab-live" hidden>
    <iframe id="live-iframe" src="https://n01darts.com/n01/tournament/comp.php?id=t_OxWz_6427&tab=live"
      style="width:100%;height:72vh;border-radius:18px;border:none;box-shadow:0 2px 20px #0002;"></iframe>
  </section>
  <!-- Squads -->
  <section id="tab-squads" hidden>
    <div class="tab-title">Squads / Player List</div>
    <div id="squads-list"></div>
  </section>
</main>
<!-- Popup for Player Cards -->
<div class="popup-backdrop" id="popup-backdrop" tabindex="-1" aria-modal="true" role="dialog">
  <div class="popup-card" id="popup-card" role="document">
    <button class="close-btn" aria-label="Close" onclick="closePopup()">&times;</button>
    <!-- Content injected by JS -->
  </div>
</div>
<footer>
  Built by SUCA Analytics
</footer>
<script>
/** CONFIGURATION */
const API_URL = "https://script.google.com/macros/s/AKfycbxg9ASk6TWcgMn4O25XgTtHdxOULY-Dlw6UpcyzWpBwEXXlNS_FoOi4BVjR4HBS55QU7A/exec";
const LOGO_URL = "https://i.postimg.cc/jSXT8DK8/temp-Image-El-Y5kn.avif";
/** GLOBAL DATA */
let allData = {}, statsData = [], standingsData = [], fixturesData = [], resultsData = [];
let filteredStats = [];
let lastSort = {col:null, asc:true};
/** INIT */
document.addEventListener('DOMContentLoaded', () => {
  setupNavigation();
  fetchAllData();
  setInterval(fetchAllData, 60000); // Refresh every minute
});
/** NAVIGATION */
function setupNavigation() {
  document.querySelectorAll('nav button').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('main > section').forEach(sec => sec.hidden = true);
      document.getElementById('tab-' + btn.dataset.tab).hidden = false;
      btn.setAttribute('aria-current', 'page');
    };
  });
}
/** DATA FETCHING */
async function fetchAllData() {
  try {
    let res = await fetch(API_URL + "?cachebust=" + Math.random());
    allData = await res.json();
    statsData = allData["PlayerStats"] || [];
    standingsData = allData["Standings"] || [];
    fixturesData = allData["Fixtures2"] || [];
    resultsData = allData["Results"] || [];
    renderAll();
  } catch (err) {
    alert("Error loading data: " + err);
  }
}
/** RENDER ALL */
function renderAll() {
  renderStatHighlights();
  renderQuickStandings();
  renderTodayFixtures();
  renderFixturesList();
  renderResultsList();
  renderStandingsTables();
  renderStatsTable();
  renderTop10Tables();
  renderSquadsList();
}
/** ----------- STAT HIGHLIGHTS ----------- */
function asNum(val) {
  let v = (typeof val === "string" && val.trim()==="") ? NaN : Number(val);
  return isNaN(v) ? null : v;
}
function renderStatHighlights() {
  if (!statsData.length) return;
  // Helper: Only consider valid, numeric, non-null, minX values
  function bestStat(col, minCol, minVal, bestFn, postFn) {
    let arr = statsData.filter(p => {
      let x = asNum(p[col]);
      let y = minCol ? asNum(p[minCol]) : 1;
      return x !== null && x !== "" && (!minCol || y >= (minVal||1));
    });
    if (!arr.length) return { value: "NA", player: "NA" };
    let best = arr.reduce((a,b) => bestFn(a,b), arr[0]);
    let val = asNum(best[col]);
    if (postFn) val = postFn(val);
    return { value: (val !== null && val !== undefined && val !== "") ? val : "NA", player: best.Player||"NA" };
  }
  // Definitions for highlights
  let highlights = [
    {
      label: "Best 3 Dart Avg",
      ...bestStat("3 Dart Avg", "Match Played", 3, (a,b) => asNum(b["3 Dart Avg"])>asNum(a["3 Dart Avg"])?b:a)
    },
    {
      label: "Best Win Rate (Legs)",
      ...bestStat("Win Rate (Legs)", "Legs Played", 5, (a,b) => asNum(b["Win Rate (Legs)"])>asNum(a["Win Rate (Legs)"])?b:a, v => ((v*100).toFixed(1)+"%"))
    },
    {
      label: "Best Win Rate (Sets)",
      ...bestStat("Win Rate (Sets)", "Match Played", 3, (a,b) => asNum(b["Win Rate (Sets)"])>asNum(a["Win Rate (Sets)"])?b:a, v => ((v*100).toFixed(1)+"%"))
    },
    {
      label: "High Finish",
      ...bestStat("High Finish", null, null, (a,b) => asNum(b["High Finish"])>asNum(a["High Finish"])?b:a)
    },
    {
      label: "Best First 9 Avg",
      ...bestStat("First 9 Avg", "Match Played", 3, (a,b) => asNum(b["First 9 Avg"])>asNum(a["First 9 Avg"])?b:a)
    },
    {
      label: "Best Leg",
      ...bestStat("Best Leg", "Best Leg", 2, (a,b) => asNum(b["Best Leg"])<asNum(a["Best Leg"])?b:a)
    }
  ];
  document.getElementById('stat-highlights').innerHTML = highlights.map(h => `
    <div class="stat-card">
      <span class="label">${h.label}</span>
      <span class="value">${h.value}</span>
      <span class="player">${h.player}</span>
    </div>
  `).join('');
}
/** ----------- QUICK STANDINGS (HOME) ----------- */
function renderQuickStandings() {
  if (!standingsData.length) return;
  let byGroup = {};
  standingsData.forEach(row => {
    let g = row.Group || "A";
    if (!byGroup[g]) byGroup[g] = [];
    byGroup[g].push(row);
  });
  let out = '';
  Object.entries(byGroup).forEach(([group, teams]) => {
    teams.sort((a, b) => (+b.Points||0) - (+a.Points||0) || (+b["+/-"]||0) - (+a["+/-"]||0));
    out += `<tr><th colspan="10" style="background:var(--primary);color:#fff;font-size:1.1em;">${group}</th></tr>`;
    out += `<tr><th>Pos</th><th>Team</th><th>P</th><th>W</th><th>L</th><th>D</th><th>For</th><th>Against</th><th>+/-</th><th>Points</th></tr>`;
    teams.forEach((t, i) => {
      let cup = getCupByPosition(i+1);
      let diff = (t["+/-"] === "#ERROR!" || t["+/-"] == null) ? "-" : t["+/-"];
      out += `<tr class="cup-${cup}"><td>${i+1}</td><td>${t.Team}</td><td>${t.P}</td><td>${t.W}</td><td>${t.L}</td><td>${t.D}</td><td>${t.For}</td><td>${t.Against}</td><td>${diff}</td><td>${t.Points}</td></tr>`;
    });
  });
  document.getElementById('quick-standings').innerHTML = out;
}
function getCupByPosition(pos) {
  if (pos <= 3) return "gold";
  if (pos <= 5) return "silver";
  return "eliminated";
}
/** ----------- TODAY'S FIXTURES ----------- */
function parseDateTime(dt) {
  // Accepts "2025-07-07T18:30:00.000Z" or Excel/Sheets date/number
  if (!dt) return "";
  if (typeof dt === "number") {
    let d = new Date(Math.round((dt - 25569) * 86400 * 1000));
    if (!isNaN(d)) return d;
  }
  let d = new Date(dt);
  return isNaN(d.getTime()) ? "" : d;
}
function formatTime(d) {
  if (!(d instanceof Date)) d = parseDateTime(d);
  if (!d) return "";
  let hh = d.getHours(), mm = d.getMinutes();
  let ampm = hh >= 12 ? "PM" : "AM";
  let hour = ((hh + 11) % 12 + 1);
  return hour + ":" + (mm < 10 ? "0" : "") + mm + " " + ampm;
}
function formatDate(d) {
  if (!(d instanceof Date)) d = parseDateTime(d);
  if (!d) return "";
  return d.toISOString().slice(0,10);
}
function renderTodayFixtures() {
  if (!fixturesData.length) {
    document.getElementById('today-fixtures').innerHTML = `<div style="color:#888;padding:12px">No fixtures scheduled for today.</div>`;
    return;
  }
  let today = new Date();
  let todayStr = today.toISOString().slice(0,10);
  let todays = fixturesData.filter(f => formatDate(f.Date) === todayStr && f["Team A"] && f["Team B"]);
  if (!todays.length) {
    document.getElementById('today-fixtures').innerHTML = `<div style="color:#888;padding:12px">No fixtures scheduled for today.</div>`;
    return;
  }
  let out = `<table class="fixtures-table"><tr><th>Team A</th><th></th><th>Team B</th><th>Time</th></tr>`;
  todays.forEach(f => {
    out += `<tr><td>${f["Team A"]||""}</td><td style="color:#a81100;font-weight:700;">vs</td><td>${f["Team B"]||""}</td><td>${formatTime(f.Time||f.Date)||""}</td></tr>`;
  });
  out += `</table>`;
  document.getElementById('today-fixtures').innerHTML = out;
}
/** ----------- FIXTURES PAGE ----------- */
function renderFixturesList() {
  if (!fixturesData.length) {
    document.getElementById('fixtures-list').innerHTML = `<div style="color:#888;padding:10px">No fixtures loaded.</div>`;
    return;
  }
  let byDate = {};
  fixturesData.forEach(f => {
    let date = formatDate(f.Date);
    if (!byDate[date]) byDate[date] = [];
    if (f["Team A"] && f["Team B"]) byDate[date].push(f);
  });
  let out = '';
  Object.entries(byDate).sort().forEach(([date, matches]) => {
    out += `<div class="date-group"><div class="date-label">${date}</div>
      <table><tr><th>Team A</th><th></th><th>Team B</th><th>Time</th></tr>`;
    matches.forEach(f => {
      out += `<tr><td>${f["Team A"]||""}</td><td style="color:#a81100;font-weight:700;">vs</td><td>${f["Team B"]||""}</td><td>${formatTime(f.Time||f.Date)||""}</td></tr>`;
    });
    out += `</table></div>`;
  });
  document.getElementById('fixtures-list').innerHTML = out;
}
/** ----------- RESULTS PAGE ----------- */
function renderResultsList() {
  if (!resultsData.length) {
    document.getElementById('results-list').innerHTML = `<div style="color:#888;padding:10px">No results loaded.</div>`;
    return;
  }
  let byDate = {};
  resultsData.forEach(r => {
    let date = formatDate(r.Date);
    if (!byDate[date]) byDate[date] = [];
    if (r["Team A"] && r["Team B"]) byDate[date].push(r);
  });
  let out = '';
  Object.entries(byDate).sort().reverse().forEach(([date, matches]) => {
    out += `<div class="date-group"><div class="date-label">${date}</div>
      <table><tr><th>Team A</th><th></th><th>Team B</th><th>Score</th><th>Winner</th></tr>`;
    matches.forEach(r => {
      let scoreA = r["Score A"]!==undefined && r["Score A"]!=="" ? r["Score A"] : 0;
      let scoreB = r["Score B"]!==undefined && r["Score B"]!=="" ? r["Score B"] : 0;
      let winner = r.Winner || ((+scoreA > +scoreB) ? r["Team A"] : (+scoreB > +scoreA) ? r["Team B"] : "Draw");
      out += `<tr>
        <td>${r["Team A"]||""}</td>
        <td style="color:#a81100;font-weight:700;">vs</td>
        <td>${r["Team B"]||""}</td>
        <td>${scoreA} - ${scoreB}</td>
        <td class="winner-cell">${winner||""}</td>
      </tr>`;
    });
    out += `</table></div>`;
  });
  document.getElementById('results-list').innerHTML = out;
}
/** ----------- STANDINGS PAGE ----------- */
function renderStandingsTables() {
  if (!standingsData.length) return;
  let byGroup = {};
  standingsData.forEach(row => {
    let g = row.Group || "A";
    if (!byGroup[g]) byGroup[g] = [];
    byGroup[g].push(row);
  });
  let out = '';
  Object.entries(byGroup).forEach(([group, teams]) => {
    teams.sort((a, b) => (+b.Points||0) - (+a.Points||0) || (+b["+/-"]||0) - (+a["+/-"]||0));
    out += `<div style="margin-bottom:23px">
      <div style="font-size:1.11em;font-weight:700;color:var(--primary);margin:9px 0 3px 0">${group}</div>
      <table class="standings-table">
        <tr><th>Pos</th><th>Team</th><th>P</th><th>W</th><th>L</th><th>D</th><th>For</th><th>Against</th><th>+/-</th><th>Points</th><th>Cup</th></tr>`;
    teams.forEach((t, i) => {
      let cup = getCupByPosition(i+1);
      let cupText = (cup == 'gold') ? 'Gold' : (cup == 'silver' ? 'Silver' : 'Eliminated');
      let diff = (t["+/-"] === "#ERROR!" || t["+/-"] == null) ? "-" : t["+/-"];
      out += `<tr class="cup-${cup}">
        <td>${i+1}</td>
        <td>${t.Team}</td>
        <td>${t.P}</td>
        <td>${t.W}</td>
        <td>${t.L}</td>
        <td>${t.D}</td>
        <td>${t.For}</td>
        <td>${t.Against}</td>
        <td>${diff}</td>
        <td>${t.Points}</td>
        <td>${cupText}</td>
      </tr>`;
    });
    out += `</table></div>`;
  });
  document.getElementById('standings-tables').innerHTML = out;
}
/** ----------- STATS PAGE - TEAM FILTER + SORTING ----------- */
function renderStatsTable() {
  if (!statsData.length) return;
  const cols = [
    "Player", "Team", "Sets Played", "Sets Won", "3 Dart Avg", "First 9 Avg", "High Finish", "100+", "140+", "180's", "Win Rate (Legs)", "Win Rate (Sets)"
  ];
  let teams = Array.from(new Set(statsData.map(x => x.Team).filter(Boolean))).sort();
  let tf = document.getElementById('team-filter');
  tf.innerHTML = `<option value="">All Teams</option>` + teams.map(t => `<option value="${t}">${t}</option>`).join('');
  tf.onchange = renderStatsTable;
  let val = tf.value;
  filteredStats = val ? statsData.filter(row => row.Team === val) : [...statsData];
  // Search filter
  let search = document.getElementById('stats-search');
  search.oninput = function() {
    let sval = search.value.trim().toLowerCase();
    let data = filteredStats.filter(r =>
      (r.Player||"").toLowerCase().includes(sval)
    );
    doStatsTable(data, cols);
  };
  doStatsTable(filteredStats, cols);
  function doStatsTable(rows, cols) {
    let ths = cols.map((c, i) => `<th onclick="sortStatsCol('${c}')">${c} <span style="font-size:0.92em;opacity:.56">${(lastSort.col===c?(lastSort.asc?"▲":"▼"):"")}</span></th>`).join('');
    let trs = rows.map((row, idx) => {
      return '<tr>' + cols.map(c => {
        if (c == "Player") {
          return `<td><button class="player-link" onclick="showPlayerPopup('${encodeURIComponent(row.Player)}')">${row.Player}</button></td>`;
        } else if (c == "Win Rate (Legs)" || c == "Win Rate (Sets)") {
          let v = asNum(row[c]);
          return `<td>${(v!==null && v!=="")?(v*100).toFixed(1)+"%":""}</td>`;
        } else {
          return `<td>${row[c] || ''}</td>`;
        }
      }).join('') + '</tr>';
    }).join('');
    document.getElementById('stats-table').innerHTML = `<tr>${ths}</tr>${trs}`;
  }
}
window.sortStatsCol = function(col) {
  lastSort.asc = (lastSort.col === col) ? !lastSort.asc : true;
  lastSort.col = col;
  let rows = [...filteredStats];
  rows.sort((a,b) => {
    let av = asNum(a[col]), bv = asNum(b[col]);
    if (av !== null && bv !== null) {
      return lastSort.asc ? (av-bv) : (bv-av);
    }
    let as = (a[col]||"").toString(), bs = (b[col]||"").toString();
    return lastSort.asc ? (as.localeCompare(bs)) : (bs.localeCompare(as));
  });
  let doStatsTable = document.getElementById('stats-search').oninput;
  doStatsTable ? doStatsTable() : renderStatsTable();
};
/** ----------- TOP 10 PAGE ----------- */
function renderTop10Tables() {
  if (!statsData.length) return;
  const categories = [
    { label: "MVP", key: "MVP", compute: calcMvpScore, minMatches: 3 },
    { label: "3 Dart Avg", key: "3 Dart Avg", minMatches: 3 },
    { label: "First 9 Avg", key: "First 9 Avg", minMatches: 3 },
    { label: "100+ Scores", key: "100+", minMatches: 3, extra: ["140+", "170+", "180's"] },
    { label: "High Finish", key: "High Finish", minMatches: 3 }
  ];
  let out = '';
  categories.forEach(cat => {
    let eligible = statsData.filter(p => +p["Match Played"] >= (cat.minMatches || 1));
    if (cat.key == "MVP") eligible.forEach(p => p._MVP = cat.compute(p));
    if (cat.key == "100+") eligible.forEach(p => p._100Total = (+p["100+"]||0)+(+p["140+"]||0)+(+p["170+"]||0)+(+p["180's"]||0));
    eligible.sort((a, b) => {
      if (cat.key == "MVP") return b._MVP - a._MVP;
      if (cat.key == "100+") return (b._100Total - a._100Total);
      return (+b[cat.key]||0) - (+a[cat.key]||0);
    });
    let top10 = eligible.slice(0,10);
    out += `<div style="margin-bottom:26px">
      <div style="font-weight:700;font-size:1.11em;color:var(--primary);margin:7px 0 4px 0;">Top 10 ${cat.label}</div>
      <div style="overflow-x:auto"><table class="top10-table"><tr>
        <th>Rank</th><th>Player</th><th>Team</th><th>${cat.label == "100+" ? "100+ Total" : cat.label}</th></tr>`;
    top10.forEach((p,i) => {
      let val = (cat.key == "MVP") ? p._MVP.toFixed(2)
        : (cat.key == "100+") ? p._100Total
        : (p[cat.key] || '');
      out += `<tr>
        <td>${i+1}</td>
        <td><button class="player-link" onclick="showPlayerPopup('${encodeURIComponent(p.Player)}')">${p.Player}</button></td>
        <td>${p.Team}</td>
        <td>${val}</td>
      </tr>`;
    });
    out += "</table></div></div>";
  });
  document.getElementById('top10-tables').innerHTML = out;
}
function calcMvpScore(p) {
  let w3DA = 3, wFirst9 = 1.5, wSetsWon = 2, wWinRate = 4, wHighFinish = 1, w100 = 0.5;
  let threeDA = +p["3 Dart Avg"] || 0;
  let first9 = +p["First 9 Avg"] || 0;
  let setsWon = +p["Sets Won"] || 0;
  let winRateLegs = +p["Win Rate (Legs)"] || 0;
  let highFinish = +p["High Finish"] || 0;
  let total100s = (+p["100+"]||0)+(+p["140+"]||0)+(+p["170+"]||0)+(+p["180's"]||0);
  return threeDA*w3DA + first9*wFirst9 + setsWon*wSetsWon + winRateLegs*100*wWinRate + highFinish*wHighFinish + total100s*w100;
}
/** ----------- SQUADS PAGE ----------- */
function renderSquadsList() {
  if (!statsData.length) return;
  let grouped = {};
  statsData.forEach(p => {
    if (!grouped[p.Team]) grouped[p.Team] = [];
    grouped[p.Team].push(p);
  });
  let out = '';
  Object.entries(grouped).forEach(([team, players]) => {
    out += `<div class="squad-team-section">
      <div class="squad-team-name">${team}</div>
      <div class="squad-player-grid">`;
    players.forEach((p,i) => {
      out += `<div class="squad-player-card">
        <button class="player-link" onclick="showPlayerPopup('${encodeURIComponent(p.Player)}')">${p.Player}</button>
        <div class="squad-sets">${p["Sets Played"]||""} Sets, ${p["3 Dart Avg"]||""} 3DA</div>
      </div>`;
    });
    out += `</div></div>`;
  });
  document.getElementById('squads-list').innerHTML = out;
}
/** ----------- PLAYER POPUP ----------- */
window.showPlayerPopup = function(playerName) {
  let name = decodeURIComponent(playerName);
  let p = statsData.find(p => p.Player === name);
  if (!p) return;
  let img = `<img src="${LOGO_URL}" alt="Player Photo" />`;
  function groupRows(label, keys) {
    let rows = keys.filter(k => p[k]!==undefined && p[k]!=="").map(k =>
      `<tr><td>${k}</td><td style="font-weight:700">${(k.includes("Win Rate")&&p[k]!=="")?(asNum(p[k])*100).toFixed(1)+"%":p[k]}</td></tr>`
    ).join('');
    return rows ? `<div class="stat-group-title">${label}</div><table class="stats-list">${rows}</table>` : '';
  }
  let core = ["Sets Played", "Sets Won", "3 Dart Avg", "First 9 Avg", "High Finish", "100+", "140+", "180's"];
  let win = ["Match Played", "Win Rate (Legs)", "Win Rate (Sets)", "Legs Played", "Legs Won", "Legs Diff"];
  let extras = ["Best Leg", "Worst Leg", "100+ Finishes", "Total Score", "Total Darts"];
  let other = Object.keys(p).filter(k =>
    !["Player","Team","Sets Played","Sets Won","3 Dart Avg","First 9 Avg","High Finish","100+","140+","180's","Match Played","Win Rate (Legs)","Win Rate (Sets)","Legs Played","Legs Won","Legs Diff","Best Leg","Worst Leg","100+ Finishes","Total Score","Total Darts"].includes(k)
  );
  let statsSections = `<div class="stats-sections">
    ${groupRows("Core Stats", core)}
    ${groupRows("Win & Rates", win)}
    ${groupRows("Highlights", extras)}
    ${groupRows("Other", other)}
  </div>`;
  let btn = `<button class="save-card-btn" onclick="saveCardAsImage()">Save card as image</button>`;
  document.getElementById('popup-card').innerHTML = `
    <button class="close-btn" aria-label="Close" onclick="closePopup()">&times;</button>
    ${img}
    <div class="name">${p.Player}</div>
    <div class="team">${p.Team}</div>
    ${statsSections}
    ${btn}
  `;
  document.getElementById('popup-backdrop').classList.add('show');
  document.body.style.overflow = 'hidden';
};
window.closePopup = function() {
  document.getElementById('popup-backdrop').classList.remove('show');
  document.body.style.overflow = '';
};
window.saveCardAsImage = function() {
  let card = document.getElementById('popup-card');
  html2canvas(card, {backgroundColor: "#fff", scale:2}).then(canvas => {
    let link = document.createElement('a');
    link.download = "player_card.png";
    link.href = canvas.toDataURL();
    link.click();
  });
};
document.getElementById('popup-backdrop').onclick = function(e) {
  if (e.target === this) closePopup();
};
</script>
</body>
</html>
